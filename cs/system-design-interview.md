- 关注整个构架，或者关注某个功能，理解scope很重要。
- **功能性设计 functional**和**非功能性设计 non-functional**。
- 功能性是实际的具体的功能。
- 非功能性一般是：Scalability可扩展性，Throuthput，StorageCapacity，Performance，Availibility
- *Back of the envelope calculation*：很多非功能性标准，无法立刻得到一个十分精确的计算结果，“信封背后的计算”是一种方便快捷的方法，用于在不需要高精度的情况下，快速得到一个大致的估算结果。这种方法强调的是效率和实用性，常用于需要快速决策的场合。
- 分布式系统很重要。

角度：

- 功能性设计，非功能性设计
- 功能性是实际的具体的功能。
- 非功能性一般是：Scalability可扩展性，Throuthput，StorageCapacity，Performance，Availibility
- 系统构架

# Rate Limiter

设计一个Rate Limiter时，可以从功能性和非功能性角度进行详细的设计，同时考虑系统架构。下面的设计将涵盖这些方面：

## 功能性设计

### 1. 定义Rate Limiting规则
- **请求限制**：明确每个时间窗口内允许的最大请求数。例如，每秒最多允许100个请求。
- **时间窗口**：确定时间窗口的长度，如1秒、1分钟等。
- **作用范围**：定义速率限制的粒度，是对单个用户、IP地址，还是全局应用。
- **操作类型**：确定哪些操作需要进行速率限制，例如API请求、数据写入等。

### 2. 请求计数和检查
- **计数器**：在每个时间窗口内，记录每个用户或实体的请求数。
- **检查逻辑**：每次新请求到达时，检查当前计数是否超过限制，如果超过则拒绝请求。

### 3. 处理溢出请求
- **响应策略**：定义在超出限制时的响应策略，如返回HTTP 429状态码（Too Many Requests），或者提示客户端稍后重试。
- **阻塞与重试**：是否支持请求排队等待，或者直接丢弃并让客户端重试。

### 4. 配置管理
- **动态调整**：支持在运行时调整速率限制规则和参数，无需重启服务。
- **多级配置**：支持不同的限流规则，可以针对不同的用户级别或API操作应用不同的限制。

### 5. 日志和监控
- **日志记录**：记录每次请求的处理结果，包括超出限制的请求。
- **实时监控**：提供实时监控视图，展示当前的限流状态和历史数据。

### 6. 清理机制
- **过期数据清理**：定期清理旧的计数器数据，确保系统资源不被耗尽。
- **错误处理**：在计数器数据出错时，能够进行自我修复或告警。

## 非功能性设计

### 1. 可扩展性（Scalability）
- **水平扩展**：设计支持多个实例水平扩展，以应对高并发请求。
- **分布式存储**：使用如Redis的分布式缓存，确保在多个节点上共享状态。
- **负载均衡**：使用负载均衡器将请求分发到不同的Rate Limiter实例。

### 2. 吞吐量（Throughput）
- **高效算法**：选择高效的限流算法（如令牌桶算法或滑动窗口日志算法）以支持高吞吐量。
- **批量处理**：对于批量请求，设计批量限流策略以提高系统处理效率。

### 3. 存储容量（Storage Capacity）
- **内存使用**：优化内存使用，确保计数器和状态信息占用最小的内存空间。
- **持久化选项**：选择适合的持久化存储（如Redis、Cassandra）来存储计数器数据。

### 4. 性能（Performance）
- **低延迟**：确保限流操作在低延迟下完成，不显著影响请求的处理时间。
- **高并发支持**：设计系统能够在高并发情况下高效运行，不会造成瓶颈。

### 5. 可用性（Availability）
- **容错性**：在某个实例故障时，系统能够继续工作，利用冗余和故障切换机制。
- **数据一致性**：在分布式环境中，确保数据的一致性和准确性，即便在高并发访问时。

## 系统架构

### 1. 单机Rate Limiter架构
- **组件结构**：
  - 请求处理器（Request Processor）：接收和处理请求。
  - 计数器管理器（Counter Manager）：负责维护和更新请求计数器。
  - 响应模块（Response Module）：决定是否允许请求并返回响应。
- **数据存储**：使用本地内存或嵌入式数据库存储计数器数据。

### 2. 分布式Rate Limiter架构
- **组件结构**：
  - 请求路由器（Request Router）：将请求分发到适当的Rate Limiter节点。
  - 分布式缓存（Distributed Cache）：如Redis，用于共享和存储计数器数据。
  - 监控与日志系统（Monitoring & Logging System）：跟踪和记录系统状态和性能。
- **负载均衡器**：在不同节点之间分配负载，确保系统均衡和高效。
- **同步机制**：使用如Redis的原子操作和事务机制，确保多节点之间的状态一致性。

### 3. 云原生Rate Limiter架构
- **容器化部署**：将Rate Limiter部署在容器中（如Docker），便于扩展和管理。
- **服务编排**：使用Kubernetes等工具管理和扩展Rate Limiter服务。
- **弹性伸缩**：根据流量动态调整实例数量，确保服务的高可用性和高性能。
